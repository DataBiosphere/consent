<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="72.0" author="raejohanek">
        <validCheckSum>ANY</validCheckSum>

        <addColumn tableName="data_access_request">
            <column name="collection_id" type="bigint"/>
        </addColumn>

        <createTable tableName="dar_collection">
            <column name="collection_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="dar_code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="create_user" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="create_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="update_date" type="bigint"/>
            <column name="update_user" type="timestamp"/>
        </createTable>

        <sql>
            for each dar (dar1)
              if dar1 already has a collection Id
                skip
              if not
                 create a new dar collection
                 assign dar1 the collection Id
                 get dar1's dar code
                 go through every other dar (dar2)
                    skip all dar2 that already have a collectionId
                    compare the dar codes for equality up to the second dash (if there is one)
                    if they are the same
                       assign the collectionId that was assigned to dar1 to dar2
                    if not
                       do nothing
        </sql>

        <rollback>
            <dropColumn tableName="data_access_request" columnName="collection_id"/>
        </rollback>

        <rollback>
            <dropTable tableName="dar_collection"/>
        </rollback>

    </changeSet>
</databaseChangeLog>
