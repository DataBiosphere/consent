@Grab('io.github.http-builder-ng:http-builder-ng-core:1.0.4')
import groovy.json.JsonSlurper
import java.util.logging.Logger

import static groovyx.net.http.HttpBuilder.configure
import static groovyx.net.http.util.SslUtils.ignoreSslIssues

/**
 * Simple script to reprocess matches for the given list of reference/purpose ids
 *
 * Requires an authentication as an admin user.
 *
 * Sample Usage:
 *   groovy reprocessMatches.groovy \
 *     `gcloud auth print-access-token` \
 *     https://local.broadinstitute.org:27443
 */

reprocessMatches(args[0], args[1])

static void reprocessMatches(String authToken, String uriHost) {
    Logger logger = Logger.getLogger("ReprocessMatches")

    //list of purposeIds to reprocess matches for, comma separated list exported from postico, first 3
    def purposeIds = ['e8b55bb4-2700-408c-9e45-1b08f1d296a4'] //, '69708bd0-6ded-4631-8e37-83e8e77df023', 'c1db0af6-4652-482e-af7e-635d2877b10f']// '5e29db1646e0fb0001acca98', '45ac6872-b9b7-4878-afd4-ee731f3b9913', 'e29f4082-bfd7-41f9-bc06-035d5e2ce53e', '68e37e50-7b36-4954-ab4e-ebedf748b378', '182ee93f-fa9a-4583-8000-b96294ed25fc', '190ba4da-9daf-4b8d-9379-cd93412aff08', '5de6cca7f6ce3300016ba99c', '5e73caa934b045000674e101', '7def5a45-cb51-4f49-9371-b948577bc6bd', '02398a2f-b8d1-4341-be2b-bd4ae2f7d3e1', 'b6300783-24f6-4a01-8d85-2524a69b6c10', '5e29d6c246e0fb0001acca95', '3f31b8fb-fe56-4ea4-af4d-98b33d3b930c', 'd72ca272-5a01-42de-b9a4-599ba6ce9511', 'b0263195-2b50-4702-9b17-71bd8ffaed7c', '4f4b32ab-803a-437b-bb71-20a7764c6e59', '18d7256f-4ad7-4875-bd0b-29ff5fb3a96f', 'e6e2abb7-cefb-42c1-868c-417049fe1cbd', 'b27179fc-28a5-4f60-a222-fb98c25db149', '00d2e122-ab58-4acd-97c7-44bc063a6566', '6dccabf5-5794-40a5-92f3-3b942ff3966f', 'e4db56df-c3bd-412b-8ebc-642ec5ce708a', '4c952600-27cc-4215-8555-2259f5b5e9a2', '40c9ba51-a408-4d3a-93fc-e1957c5fe154', '5c42b1ad-93ce-4a43-87e4-54274507db3f', '30565a82-fc7c-4c3d-b01a-07e92ff0c111', 'd2c0fd21-f2ad-41f1-8a39-114036340b25', 'e9af54b6-a5fc-46e3-9457-4118e5cc584c', '3203156e-c57e-4cc7-bab9-17ee768fc90e', '6ebc0d0e-70bc-4c63-a3ac-8470f0143fdf', '53515c83-b030-42b6-8cd7-ee73aeb824b4', 'cd3fcd5a-864c-43db-85ee-0f7c19108378', '76bab364-af4f-457e-aeb7-cb32e6a2e1cc', '5922760c-3c99-44e3-aa6c-06d4ed4663ff', 'e6306d4e-e4d4-4aee-b3a6-2bff204f8e88', '86e4362b-f1ae-4730-9bd9-185d516cab7b', '9f08e1c6-5d50-48e7-838e-3f3cfad5eff9', '3527ea53-1fc6-4686-8205-b175b3f8aa38', '06166f52-9d78-4dd6-aa89-63246da37a8d', '5da9edc0a7b11b0001f52940', 'b50cf6f6-d5c2-4ba3-aba3-3fd6e933f0d2', '74dd5278-a2ca-4035-b8ce-caa3f9ad8f01', '84ac0361-13e3-45be-a94c-335cf3d48805', '7da90606-00df-4516-9424-c8ca0ba85dd3', 'b8d39419-5fda-4624-a59a-db05e74a7948', '267c0f00-34c4-4411-bd34-a325e01a61a8', '250539e0-303e-4907-97de-58c719e16cc3', '99e303d9-9836-4fbe-8025-f75ee153f252', 'e68af85e-df88-4fac-906d-43a4b2586c6e', '97457317-b17c-4fe7-b721-3aebbeb5a0ac', '0f753dc7-5133-470c-922f-e2ac9636adbc', 'b6a9d76b-b70e-4ff7-871d-cb7a55c53143', 'f02c439f-70dc-4bd2-881e-b94c3875c152', '3c69ff98-ae38-411b-8a5b-bd8d82d6930d', '2c9a9e03-cb67-4c98-99cd-8a8255496a87', '8d8bce3a-f4c8-481a-8ca0-4c02b91f7535', '079b3333-912e-4981-8c83-c1ada21baa07', '29e9f593-9444-4d0b-b38a-fbf4a627e1c3', '72aa433d-0df7-4f26-988f-a0d25515bd3e', '94e539a8-4556-41d4-968b-d956f79937ad', 'fc8877a8-f66e-43e2-9194-6a699a90bd45', 'dfe806a3-3af3-47df-a9cb-017aae74187f', 'e02aa758-cb9b-4c01-8bc7-a525f8fb96c1', '22350b81-d09b-4b83-abdb-7cf5fe78aa27', '97aa6f70-7c0b-44d0-8f93-a31eb377a248', '4f9a06ea-8f93-445e-a3b8-1ae9482804c1', '0c6b637d-195a-4531-8e29-fdf94a0f4239', 'f4561faf-aaea-41c4-a600-cc4b6d4499ca', '0bbdb785-6b39-4020-b818-32e4e6a1f452', 'c8a5ca92-62d9-4e56-b543-8d7ef143e5cc', '66168a30-fe3a-432c-9b3c-67f98b11c872', '84ab2b7b-eb81-4174-8bc9-3dc621baf378', '231b82b6-10ef-4149-a82c-ba3481365c56', '88278d1a-25b4-49c6-9a51-9da99fb24059', '5ced683446e0fb0001f6f012', 'b58a603d-9943-4a42-9769-5391b8736e11', '850534d7-3ec0-41b9-9c2d-6704f3b23b82', '88024060-68a6-4b6c-b449-38a2d23076ed', '00bc968f-028e-43ed-a2ec-1a0bac032e66', '7c7d9c3d-163a-4af6-88f9-fff811aaca32', '8cc9737f-47c9-4f88-ae41-a523d464ed20', 'cfa0c474-a851-492e-8e54-8659d807a73e', '3d6fc188-c69a-4b03-b37f-df3ba2ddf9c3', 'f2f48cba-be1a-4b97-aee7-8de6dda7f222', 'e44d51ef-50be-4299-877e-4895f0b3ce4c', '7f9e8713-cf1b-47ce-aff4-ad37c2def96c', '6ac6acdd-dce1-4d89-baa1-c3e7bb0a1930', '5e29db1646e0fb0001acca99', '2df758a2-ca66-4a85-b8cd-1ce70f67726a', '50320733-f4d2-45a9-b60a-7584fd3374ff', '5fb2f8fe-0208-4858-ab75-f0430886d757', 'a06826c1-b084-42b1-a0d0-713217c680b5', 'ab8ff22b-f0be-4622-803e-b1a23ebc4573', '37b3a099-6317-41ab-9bc3-3d051575d82b', '872336a3-3b51-4600-8786-37d8b71dd8fe', 'bc325fcb-ff0f-4c4e-a8a5-2e632d86b383', 'c57e43e7-822a-4840-84bf-bc11aea8c47e', '319b6044-74b4-449c-94e1-e52d65ee15a0', '418b68b6-2138-4d0e-b784-c81dea247b63', 'd51773bf-6189-4a26-bf04-e37fb7a247ea', '9b5ac4e1-8b00-49e5-a89c-e5a041d825ad', 'd65b84ad-33b8-4b8a-ad23-db53323caaef', '72046dd9-322a-441d-8d78-701656a3513e', 'd7dcaf4e-33f4-498e-841a-7624370e8637', '5e59312a46e0fb000182caba', '696e9ce7-06e0-4248-bdc3-681a1c77fb0b', '508c4555-9183-43eb-9891-04661d42a3b5', 'b9ca5435-44f0-42c1-9f6f-e668179ff187', '6b0b8eac-9fb0-47cf-8203-55f96f2c464a', '283634e1-7475-404f-a8f8-986e4873ed6c', '58c3f5a5-9c79-4cf4-ad36-9e883840ac11', '43dd6411-c86e-4771-8eb1-58036e483cd0', '10462fd6-da97-47b7-8f1d-122a75b38617', '5ed6af25-8207-4a76-87fa-531b400956e6', '5e29dba546e0fb0001acca9c', '933a2cbc-086e-4231-9956-2e72688ac411', 'ed36c9f9-9802-44c6-ba03-ccd900d841d1', '27125748-1b3d-488e-80e2-595eee2ba2f7', '8cd15caa-9c5d-4a9c-b077-d153d7e5b3c2', '49ffa7f2-6837-45b8-b4cd-568dad5acf07', 'add74409-71f6-4f6e-9f5a-aba06390b72c', '9113e09f-1f2a-4568-bcfe-42f2f03352e8', 'eddda977-2e9b-4682-9668-f84f7faec8d4', '7ed94d7e-d86f-4efe-81c0-cc84f00f79c2', 'd3cd88c7-6477-49d1-a112-d8117053fa6d', '8125045e-7fe2-4d92-8d3b-79ff669cb081', '7010f66f-9e49-4ade-a58b-c2866fb2cf5c', '4ed11dd0-0c91-47dc-b979-b2318dacc307', '10b51b62-adef-44c7-8dda-d337c3b23d66', '4716f787-ea5a-4597-bd67-943e60f6d94d', '5eac990d-50d5-4b4e-846c-77386a9e9e4c', '3f7fdc35-52ea-40d8-b500-af392a85316b', '7d482d09-8e8d-4fe3-bd81-ae62d3a6b3a0', '5daa040f08813b000184c933', '9fb4dd99-ca30-4857-8373-26ccc002bf3b', '746cb262-a571-4435-aabe-a0cec6b6c238', 'bb9b9527-72cd-48aa-a796-a7eda9ebc618', '79e035ae-e1c8-48f2-bdc6-4c5037d3fc48', 'c6688d3f-6263-42cb-9ec0-ac832d76ce2a', 'd424739e-44ae-4c3e-9e81-af9c79d0d40f', '4658ae5c-3c54-4b06-af27-059cab85d700', '1a7da7ec-1203-4272-ac48-9c7808b517a5', '4b08991a-9663-402a-934b-301fde576bc3', 'd11f695e-adf6-47fd-a338-42a5589f654e', 'f99fbe0e-6427-463d-a61c-394c27db2472', 'd68ac783-3375-4567-b00d-48480a0a2f45', '47484293-805e-407d-9101-0aa8051fc5c9', '5e149ba346e0fb0001ef5994', 'efe2b838-fd15-485f-96e2-cbbde8dfd227', '084fd430-f7f7-492d-ad1d-5d0d4a28d6c4', 'b8e9ac1d-23d0-4a4a-a68a-c178604bdc5b', 'b2eddb0e-5f42-4bc9-9752-f26cb312b70f', '185007ea-cc18-4979-a0eb-25ab6f3c6cc0', 'baf29a0a-0dfd-4e33-995e-b240577b3f95', '8e152243-fec0-40e8-966e-f89eb804ed6a', '8bc3e4fb-7661-4f35-b7d1-a0b338471c89', 'b637a0ae-e568-4cf8-a24b-51ba1be47ccb', '1724d042-1386-4ba6-b4ad-d2686a38050b', 'd7b76e6b-a62c-4262-aee7-fa9f4d6ef57b', 'a5685264-1160-424d-a8b3-d73a860c132b', '68012e05-a76b-4672-89aa-d2d184f4dafb', 'bd32b149-626d-460b-84e3-d655009159c2', '5de6cca7f6ce3300016ba99b', '5e4d92c3b834740007585a6e', '0fe823ad-cd25-4956-908e-ba5f9e34b9c8', 'd7d0ab87-f014-4649-b45c-6bc7c1a21613', 'd86f258b-df82-4e14-8f3e-0fc44df97e6b', '963b8768-5486-4f26-a26d-a64a8646c4b8', '564f6802-a3d7-4860-b0fc-ec435ff4126a', 'f9a5c710-8ce7-4ae4-8dd0-dc8eb1df294d', '9c795891-149b-4cd7-a32e-f4888a738879', '4b379621-e4b0-4b3f-b169-b12ce2e70953', '6cdb3cb8-f5fe-4dcb-bf29-2015ef26f7f1', '1fddd9e8-bf57-4461-a45c-32e627581cec', 'bf971eb6-fbcd-4e0e-8662-0e25125a4b79', '2b91a27f-6875-4dd7-a1ab-39a4565a2730', '03d7b49a-0259-4d84-8bd2-bfaa96cb2ffd', '87544d61-db5d-4331-98a7-1751e9d7d41d', 'b50a7716-543f-41d9-9abb-76104e238b49', 'cc07ebe8-1370-43f2-bc22-33728bb8d433', '5daa1e79c414790001d0ad61', '9c111b7a-7cc3-459a-a1fa-30f6edba2329', '0f55e834-c2fb-4979-b39b-bd55d919c276', '0d562de7-23d9-4ee2-a228-29afe7fdaff5', '7929a6b9-c9b5-49eb-bd03-ce8aa475da80', 'd914d34e-3fba-4127-b7f9-0f88c8a1ebc6', '6a823324-83ff-41a3-9244-8fd9128b1f8c', 'a8027a98-6b95-4aa5-9dcb-9b62c2acfda2', '8708bed4-bd7d-4386-b6db-35ef21a92022', '54a16664-b4c1-4c35-9cd7-6b6fef6d38e6', '9e4067f5-1320-4eb4-a0b5-0d9b4e869a65', '19eb2ddb-33a1-41d1-bab2-c1e44d29e812', '828b1fb8-c5b0-4ed6-88d5-4e00bd53a57e', 'eb1dc46e-2d92-4c98-b03d-b093e44a8c03', 'e554309f-44dc-4909-ba96-6624b5c1fe5c', 'bf3ab662-bfa1-4757-a8fc-b104b3b508dc', '7042ff93-b420-4d6d-86b5-8a46c0c43122', '8e1c64c1-3cf3-49ea-94b7-41ad713ee6e2', 'acaa6b5a-9787-44cd-ae62-537f6b02d44a', '8a126bbb-3182-4a81-a7ab-19112dbe614a', '808c0bbe-88cc-49fa-b5b0-31a014fc4651', '3d21b66e-7cb4-49de-91f2-a50c4cfd2a0f', '5ca581ba-29f5-44e6-9e80-1f6cf4ab06dd', '3d39709d-5278-474e-9d92-b1ea9e5fd1e3', 'f8524e49-45b5-4fdc-83a3-c718f3574373', '6ed7012d-bee1-414a-8c6e-d87682300bd1', '0dd60d0c-17a8-44e5-ae86-d4921bd10ea3', 'cebc6d04-31bf-4387-8497-6f0970428e62', '71daa175-99cd-4dd3-af5d-5498d17236e6', '32f02c58-cf9b-433b-97ba-3dc9bc0c8115', 'fe74a346-65a1-421b-961e-5dd7a86b3d1d', '052e14e6-a297-4dc3-a9f3-85be488f2bcd', '8847efda-18c5-4804-85ba-a2031d646d65', '5daa0fc6e64ada0001b7055b', '5a8817bd-0664-4cf1-b058-0923922b9e8c', '9b287bd6-5d74-475c-a302-045da94a8c29', 'c4373776-529a-4655-b412-55d3253e292a', '525abdfa-0d58-4ba1-8134-f2d7efe0d4ff', '5e29dba546e0fb0001acca9b', 'a0fc6db3-ccb2-4a15-94d5-fbe8d42f05c5', '89428b56-a885-4082-9e35-77f4fea00c85', '45341dfa-777e-4e21-b617-f527c2ac57bb', '5e29d6c246e0fb0001acca96', 'c514bcc1-f25d-4f75-8f02-b6be0182744b', '5e42f88746e0fb0001aa9539', 'e3304ed2-2553-4467-998e-56a35884dade', 'e3d026cb-aa64-47f2-bb57-263de117b137', '7354ea91-45e5-48b8-9935-f0876a7d6927', '878c026b-4c03-461d-af15-e90bbf512922', 'c9f2eb17-f417-4ebf-8712-b376d7637c27', 'b6f4b52f-ed3b-4314-a246-fa259518d363', '4445f0be-ee00-45ab-9708-4da484c141eb', 'e0773a44-ce4c-4156-b718-1eb55efc0d43', 'a670181a-13cd-43f9-8a30-38bd79d41e7a', '99c2aa7d-21d8-4286-849c-f762a585c473', 'c5c0b9f6-2dfd-4683-b472-dd4e6a679608', '5e4d92c3b834740007585a71', 'ce7b294a-1993-4e9e-8d1c-58354f2b0caa', 'db9f82b7-d115-4c0a-b979-ea76a01bceae', 'b6e424fc-f639-4c23-9587-a09410f7a020', '5757afeb-fc8d-4051-a7e1-c3b41574863a', '4f65a1ef-da2b-4dfd-ba43-0562016e7f9a', '45242f7e-0765-4865-8980-efe92d8118d9', '49f55aa3-1f06-40b9-9822-d0e2c0c2a94a', 'f975020e-cfd3-445a-8e7b-897b84df41ca', '3bb293e2-fe24-4be5-b81e-627515ff2b1b', '6133e82d-64b8-486e-b724-152056c9835b', 'ff8d605f-d6f6-4114-abcf-1899abd1c08d', '8af1ecc1-bd8c-4c20-befd-ca1a76809263', '13410bdc-f9fc-42f1-a119-6c6be058c93c', '5e4d923db834740007585a6d', '66d05c26-6bab-492a-9d54-7c3333bcc6f7',
     //'5ced56ff46e0fb0001f6f00c', '0c89cee8-aea1-4651-aecc-08ae1d5b07a6', 'b0fa350d-87e7-44e0-b41a-356ebdaa848e', 'f4507990-6fc8-4c59-8517-416fa03dbcb1', '6e1dd54d-24f4-4875-8f9c-c956deabae48', '5ced40e546e0fb0001f6eff5', '6c7ee27c-0e1a-4a9b-935c-b3ee721b2d25', '4cbed25e-e328-4fe7-b8b0-b339bfc34740', '4c597dfa-8c29-4ef0-9f19-a1b7127f6fd0', '11581557-ca2a-4af8-b101-687f4e99bb7f', '07bbedb5-a302-4ebe-822a-26b3cb6744f0', 'df934339-930d-4661-83d7-bc8d27b762fc', '153f5860-a1fb-440b-a578-5a340c832882', '401be168-5851-459e-8a1d-3251ca32eed2', 'dcbaff5a-9119-45b6-8ab6-ec98c28e360d', '5e29db1646e0fb0001acca97', 'cb3314cc-016e-4e25-b88c-7e280f729fa9', '5dd6a31a46e0fb0001b2e744', 'c4c3d29b-f3d1-46aa-9c50-5aad80680128', '96c90de9-e1f7-42ff-8d2d-c9cb5be7b5d5', '6b712616-a159-4af2-a259-91ba88c4bd21', '1d01f8b7-215a-4b83-b69a-d363377b2484', '46c9d87a-43a7-4a29-9365-29f6aef92f6d', 'd8449020-4ff6-4c3c-aa2a-ecfab512db9a', '63e1df37-cd5b-46ea-8b8f-1921b832183a', '438649ab-981d-4d58-a6da-d6478903ff1b', '613d0b15-0fa7-4b22-896c-e6bb52c745e9', 'f6e5f3a3-330a-4e5c-a3e3-2efbe0ab8765', '87c023a8-482a-4526-8b9a-10e6ebad44de', '954e7aef-07f2-4d8e-8038-356ac8d51d14', 'f7e172b7-592c-40f1-9348-cf78479a3bb2', '5ced763b46e0fb0001f6f027', 'f6d2024f-d373-458a-bcc0-94885f5ac169', 'cb6da684-fc71-4dc6-bfc1-92690c8b71fe', 'ffa351d7-695c-4c0d-a8db-f215b6a204f5', '459ce7bc-4b96-4c1b-9e87-ccf2d4fd8306', '72d392fa-0727-480a-8a61-316c3a13cd68', 'ee38c8c4-e63e-428c-aadf-d44a99585452', '122b5212-7a73-431e-8fc7-40717db0e206', '35dec800-4d1e-419d-a1e7-ecbe05f85d46', 'c648efff-0054-496f-abb8-b43e0af06c61', '3a9ca633-5dbb-4c55-a4b8-f00226b2b7aa', '7564b15a-406e-4007-b457-99310e3db12c', '2a1b0e95-e1f7-4c07-9c3d-dfce3da93033', 'd764d90d-8d45-4017-b1c8-c563f43842a2', '5e4d9130b834740007f265ef', '593c870a-7ce9-46fa-b065-4f50b8759573', '3a1ecd6c-5979-4c0f-b67d-02e83495cece', '0cfeea40-c698-4ef9-8a75-2bfd88c830d9', '3edd3287-6b1b-4b31-84b8-0ad6fe5f4754', '4bf443c8-975e-4689-bc12-218ec6bbef3b', '6a6ee143-fb4e-4f30-91aa-c1d356ec020a', 'f0703ba8-0416-4891-ab47-034249e8bf25', 'd38f75c4-13dd-4bac-8adf-104d252ead95', '1020b44e-fef2-44e8-b6d8-be431cfd471b', '31c0fccc-f4d0-4358-a697-4697cd81214c', 'bac31fac-61b3-4193-b0b2-e06727c86690', '7ac1d854-e527-4a91-b3a4-9d18fb77b6dc', '5e4d92c3b834740007585a6f', '94bfbcfd-6a73-4f70-b869-bc64fad23c3a', '5e4d92c3b834740007585a70', '6291e9a6-0681-4588-a05a-e146bc791718', 'b9911321-7a07-49d9-b1fa-eceba657f1ea', 'e4bcc9fc-a798-40fa-bda1-8a1c9fcd12fd', '490fb03f-b77e-4564-b246-da5d826c9c15', '1fba11a1-ce18-4f32-950b-b7ab3f73e1b3', 'da73aaca-3823-4f44-a760-6489bf1d3410', '6970da5b-69a6-429b-94a1-9442dc3f920a', '54319e06-3189-46d6-a2df-84c64b9dde53', '5ced4c6646e0fb0001f6f005', '0507cf08-c697-4cab-b036-71eaa1494ad5', 'a4387f05-e1a9-4510-82fb-7591ba8b4cf5', '0ad3e41c-850d-4ad2-bb40-782616853c33', '3ddca19a-763a-4107-9dae-9a82d723e4f8', '554fdb04-041b-495a-a6e5-84739cf22b69', 'b55d07d5-eb01-4b95-ae21-efa7e062869f', '364cb0ad-daad-41bd-b1b6-34b01b0711da', '76415018-63ec-48d2-a708-a87777c84221', '2b3ca47f-9e87-401c-8d96-833421db0f23', '4a2ae962-cba2-4e2a-a382-c29a19bf2de9', 'd54a71da-e9d8-434f-882d-b5fd6c7a2782', '20c120ad-2771-4ea7-b52d-a6cf12e64930', '5e29dba546e0fb0001acca9a', '632d9eb1-475a-4953-9187-1b4104051ffa', '6afeebf4-5e1a-495d-8df3-24b44d4b3671', '54fa4a3b-b95a-4118-a723-e21888300b2b', 'b639dfce-fed8-4c78-9353-9f75d4ad1237', '61b53e0f-5a10-4c55-a2cc-2ff9f183912a', '69a7cca2-a14a-4f44-9d4a-92177fd4b569', 'afe05a53-1e22-4476-886c-d3a7c5e0c4c8']

    purposeIds.each { id ->
        reprocessMatch(authToken, uriHost, id)
        logger.info("Reprocessed Match for: ${id}")
    }
}

static Object reprocessMatch(String authToken, String uriHost, String purposeId) {
    Logger logger = Logger.getLogger("ReprocessMatch")
    configure {
        ignoreSslIssues execution
        request.uri = uriHost
        request.uri.path = "/api/match/reprocess/purpose/${purposeId}"
        request.contentType = 'application/json'
        request.accept = 'application/json'
        request.headers['Authorization'] = 'Bearer ' + authToken
    }.post {
        response.parser('application/json') { cc, fs ->
            String thing = new JsonSlurper().parse(fs.inputStream)
            logger.info(thing)
            thing
        }
        response.exception { t ->
            logger.severe("Error: " + t.message)
            logger.severe("Error reprocessing: " + purposeId)
        }
    } as Object
}
